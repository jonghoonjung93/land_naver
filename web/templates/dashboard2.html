<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kay's Stock Dashboard - 6 Split Layout</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        background-color: #131722;
        color: #fff;
        font-family: sans-serif;
        overflow: hidden;
        height: 100vh;
        width: 100vw;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        height: 100%;
        width: 100%;
        gap: 2px;
        background-color: #000;
      }
      .chart-box {
        position: relative;
        width: 100%;
        height: 100%;
        background-color: #131722;
        overflow: hidden;
      }
      .input-group {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 10;
        background: rgba(0, 0, 0, 0.85);
        padding: 6px;
        border-radius: 4px;
        display: flex;
        gap: 5px;
        max-width: calc(100% - 16px);
      }
      input {
        background: #2a2e39;
        border: 1px solid #434651;
        color: #fff;
        padding: 4px 6px;
        border-radius: 3px;
        text-transform: uppercase;
        font-weight: bold;
        width: 150px;
        font-size: 11px;
      }
      input[type="number"] {
        width: 130px;
        text-transform: none;
      }
      button {
        background: #2962ff;
        border: none;
        color: white;
        padding: 4px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-weight: bold;
        font-size: 10px;
      }
      button:hover {
        background: #1e53e5;
      }
      .tradingview-widget-container {
        height: 100%;
        width: 100%;
      }

      /* ìˆ˜ìµ ê³„ì‚° íŒ¨ë„ ìŠ¤íƒ€ì¼ */
      .profit-box {
        display: flex;
        flex-direction: column;
        padding: 15px;
        background-color: #1a1d29;
      }
      .profit-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #fff;
        border-bottom: 2px solid #2962ff;
        padding-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .realtime-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        font-weight: normal;
      }
      .realtime-toggle input[type="checkbox"] {
        width: auto;
        margin: 0;
      }
      .countdown-timer {
        font-family: monospace;
        font-size: 13px;
        color: #ffd700;
        background: rgba(0, 0, 0, 0.5);
        padding: 2px 8px;
        border-radius: 3px;
        min-width: 50px;
        text-align: center;
      }
      .countdown-timer.paused {
        color: #666;
      }
      .profit-content {
        display: flex;
        gap: 15px;
        height: calc(100% - 50px);
      }
      .market-info {
        flex: 1;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .market-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        padding: 5px 0;
        border-bottom: 1px solid #333;
      }
      .market-row:last-child {
        border-bottom: none;
      }
      .market-label {
        color: #9ca3af;
        font-size: 13px;
      }
      .market-value {
        font-weight: bold;
        font-family: monospace;
        font-size: 15px;
      }
      .profit-calculation {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .profit-inputs {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 12px;
      }
      .profit-input-group {
        flex: 1;
      }
      .profit-input-group input {
        width: 100%;
        font-size: 12px;
        padding: 6px;
      }
      .input-row {
        display: flex;
        align-items: flex-end;
        gap: 6px;
      }
      .input-row > div {
        flex: 1;
      }
      .exchange-rate-inline {
        max-width: 80px;
      }
      .profit-input-group label {
        display: block;
        color: #9ca3af;
        font-size: 11px;
        margin-bottom: 5px;
      }
      .profit-input-group input {
        width: 100%;
        font-size: 14px;
        padding: 8px;
      }
      .profit-results {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .profit-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
      }
      .profit-label {
        color: #9ca3af;
        font-size: 13px;
      }
      .profit-value {
        font-weight: bold;
        font-family: monospace;
        font-size: 15px;
      }
      .profit-positive {
        color: #00e676;
      }
      .profit-negative {
        color: #ef5350;
      }
      .price-positive {
        color: #00e676;
        font-weight: bold;
      }
      .price-negative {
        color: #ef5350;
        font-weight: bold;
      }

      /* ì…ë ¥ íˆìŠ¤í† ë¦¬ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
      .input-history-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #1a1d29;
        border: 1px solid #434651;
        border-radius: 4px;
        margin-top: 2px;
        max-height: 150px;
        overflow-y: auto;
        z-index: 100;
        display: none;
      }
      .input-history-item {
        padding: 8px 12px;
        cursor: pointer;
        color: #fff;
        font-size: 12px;
        border-bottom: 1px solid #333;
      }
      .input-history-item:hover {
        background: #2962ff;
      }
      .input-history-item:last-child {
        border-bottom: none;
      }
      .input-history-empty {
        padding: 8px 12px;
        color: #666;
        font-size: 11px;
      }
      .update-time {
        font-size: 10px;
        color: #666;
        text-align: right;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #333;
      }
      .realtime-badge {
        display: inline-block;
        background: #26a69a;
        color: white;
        font-size: 9px;
        padding: 2px 6px;
        border-radius: 3px;
        margin-left: 5px;
      }
      .save-btn {
        align-self: flex-end;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Row 1: TSLA | QQQ | USDKRW -->
      <div class="chart-box" id="box1">
        <!-- ìˆ˜ìµê³„ì‚° ëª¨ë“œ (ê¸°ë³¸ ìˆ¨ê¹€) -->
        <div id="box1_profitMode" class="profit-box" style="display: none; height: 100%; width: 100%; overflow: hidden">
          <div class="profit-title">
            <div style="display: flex; align-items: center; gap: 5px">
              <input
                type="text"
                id="box1_ticker"
                value="TSLA"
                style="background: transparent; border: 1px solid #444; color: #fff; font-size: 16px; font-weight: bold; width: 60px; text-align: center; text-transform: uppercase"
                onchange="
                  saveProfitData('box1');
                  fetchTeslaPrice('box1');
                "
              />
              <span>ìˆ˜ìµ ê³„ì‚°</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px">
              <button onclick="toggleMode('box1')" style="padding: 4px 8px; font-size: 14px; height: 24px" title="ìˆ˜ìµê³„ì‚°/ì°¨íŠ¸ ì „í™˜">ğŸ’«</button>
              <button onclick="saveProfitData('box1')" style="padding: 4px 10px; font-size: 11px; height: 24px">ì €ì¥</button>
              <label class="realtime-toggle">
                <span class="countdown-timer" id="box1_timer">05:00</span>
                <input type="checkbox" id="box1_realtime" onchange="toggleRealtime('box1')" />
                <span>ì‹¤ì‹œê°„</span>
              </label>
            </div>
          </div>
          <div class="mode-content" style="height: 100%">
            <div class="profit-inputs">
              <div class="input-row">
                <input type="radio" id="box1_selectSet1" name="box1_priceSet" value="1" checked onchange="calculateProfit('box1')" style="width: auto; margin-bottom: 8px; flex-shrink: 0" />
                <div class="profit-input-group">
                  <label>ë§¤ì…ê°€ ($)</label>
                  <input type="number" id="box1_buyPrice1" placeholder="350.00" step="0.01" onchange="calculateProfit('box1')" />
                </div>
                <div class="profit-input-group">
                  <label>ì£¼ì‹ìˆ˜</label>
                  <input type="number" id="box1_shareCount1" placeholder="100" step="1" onchange="calculateProfit('box1')" />
                </div>
                <div class="profit-input-group exchange-rate-inline">
                  <label>í™˜ìœ¨</label>
                  <input type="number" id="box1_exchangeRate1" placeholder="1470" step="1" value="1470" onchange="calculateProfit('box1')" />
                </div>
              </div>
              <div class="input-row">
                <input type="radio" id="box1_selectSet2" name="box1_priceSet" value="2" onchange="calculateProfit('box1')" style="width: auto; margin-bottom: 8px; flex-shrink: 0" />
                <div class="profit-input-group">
                  <input type="number" id="box1_buyPrice2" placeholder="300.00" step="0.01" onchange="calculateProfit('box1')" />
                </div>
                <div class="profit-input-group">
                  <input type="number" id="box1_shareCount2" placeholder="50" step="1" onchange="calculateProfit('box1')" />
                </div>
                <div class="profit-input-group exchange-rate-inline">
                  <input type="number" id="box1_exchangeRate2" placeholder="1470" step="1" value="1470" onchange="calculateProfit('box1')" />
                </div>
              </div>
            </div>

            <div class="profit-content">
              <div class="market-info">
                <div class="market-row" style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid #444">
                  <span class="market-label" style="font-size: 13px">í˜„ì¬ê°€:</span>
                  <span class="market-value" id="box1_currentPriceMarket" style="font-size: 20px">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="market-row"><span class="market-label">ì‹œì¥:</span><span class="market-value" id="box1_marketInfo">-</span></div>
                <div class="market-row"><span class="market-label">ë“±ë½:</span><span class="market-value" id="box1_changeInfo">-</span></div>
                <div class="market-row"><span class="market-label">ë“±ë½ë¥ :</span><span class="market-value" id="box1_pctInfo">-</span></div>
                <div class="market-row"><span class="market-label">ì‹œê°„:</span><span class="market-value" id="box1_timeInfo">-</span></div>
                <div class="market-row" style="margin-top: 8px"><span class="market-label">ìƒíƒœ:</span><span class="market-value" id="box1_statusInfo" style="font-size: 12px">-</span></div>
              </div>
              <div class="profit-calculation">
                <div class="profit-results">
                  <div class="profit-row"><span class="profit-label">ìˆ˜ìµë¥ :</span><span class="profit-value" id="box1_profitRate">-</span></div>
                  <div class="profit-row"><span class="profit-label">ìˆ˜ìµê¸ˆ($):</span><span class="profit-value" id="box1_profitAmount">-</span></div>
                  <div class="profit-row"><span class="profit-label">ìˆ˜ìµê¸ˆ(â‚©):</span><span class="profit-value" id="box1_profitAmountKRW">-</span></div>
                  <div class="profit-row"><span class="profit-label">í‰ê°€ê¸ˆ($):</span><span class="profit-value" id="box1_totalValue">-</span></div>
                  <div class="profit-row"><span class="profit-label">í‰ê°€ê¸ˆ(â‚©):</span><span class="profit-value" id="box1_totalValueKRW" style="color: #ffd700">-</span></div>
                </div>
                <div class="update-time" id="box1_updateTime">-</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ì°¨íŠ¸ ëª¨ë“œ (ê¸°ë³¸ í‘œì‹œ) -->
        <div id="box1_chartMode" style="width: 100%; height: 100%; position: relative">
          <div class="input-group" style="position: relative">
            <input type="text" id="input1" value="VANTAGE:TSLA" onkeypress="handleEnter(event, 1)" onclick="showHistoryDropdown('input1')" onblur="hideHistoryDropdown('input1')" autocomplete="off" />
            <div id="input1_history" class="input-history-dropdown"></div>
            <button onclick="updateChart(1)">Change</button>
            <button onclick="toggleMode('box1')" style="padding: 4px 8px; font-size: 14px; margin-left: 5px">ğŸ’°</button>
          </div>
          <div id="chart1" class="tradingview-widget-container" style="height: calc(100% - 40px)"></div>
        </div>
      </div>

      <div class="chart-box" id="box2">
        <div class="input-group" style="position: relative">
          <input type="text" id="input2" value="VANTAGE:QQQ" onkeypress="handleEnter(event, 2)" onclick="showHistoryDropdown('input2')" onblur="hideHistoryDropdown('input2')" autocomplete="off" />
          <div id="input2_history" class="input-history-dropdown"></div>
          <button onclick="updateChart(2)">Change</button>
        </div>
        <div id="chart2" class="tradingview-widget-container"></div>
      </div>

      <div class="chart-box" id="box3">
        <div class="input-group" style="position: relative">
          <input type="text" id="input3" value="FX_IDC:USDKRW" onkeypress="handleEnter(event, 3)" onclick="showHistoryDropdown('input3')" onblur="hideHistoryDropdown('input3')" autocomplete="off" />
          <div id="input3_history" class="input-history-dropdown"></div>
          <button onclick="updateChart(3)">Change</button>
        </div>
        <div id="chart3" class="tradingview-widget-container"></div>
      </div>

      <!-- Row 2: ìˆ˜ìµê³„ì‚° | BTC | AAPL -->
      <div class="chart-box" id="box4">
        <!-- ìˆ˜ìµê³„ì‚° ëª¨ë“œ (ê¸°ë³¸ í‘œì‹œ) -->
        <div id="box4_profitMode" class="profit-box" style="display: flex; height: 100%; width: 100%; overflow: hidden">
          <div class="profit-title">
            <span id="box4-title">TSLA ìˆ˜ìµ ê³„ì‚°</span>
            <div style="display: flex; align-items: center; gap: 10px">
              <button id="toggleModeBtn" onclick="toggleMode('box4')" style="padding: 4px 8px; font-size: 14px; height: 24px" title="ìˆ˜ìµê³„ì‚°/ì°¨íŠ¸ ì „í™˜">ğŸ’«</button>
              <button onclick="saveProfitData('box4')" style="padding: 4px 10px; font-size: 11px; height: 24px">ì €ì¥</button>
              <label class="realtime-toggle">
                <span class="countdown-timer" id="box4_timer">05:00</span>
                <input type="checkbox" id="box4_realtime" onchange="toggleRealtime('box4')" />
                <span>ì‹¤ì‹œê°„</span>
              </label>
            </div>
          </div>
          <div class="mode-content" style="height: 100%">
            <div class="profit-inputs">
              <div class="input-row">
                <input type="radio" id="box4_selectSet1" name="box4_priceSet" value="1" checked onchange="calculateProfit('box4')" style="width: auto; margin-bottom: 8px; flex-shrink: 0" />
                <div class="profit-input-group">
                  <label>ë§¤ì…ê°€ ($)</label>
                  <input type="number" id="box4_buyPrice1" placeholder="350.00" step="0.01" onchange="calculateProfit('box4')" />
                </div>
                <div class="profit-input-group">
                  <label>ì£¼ì‹ìˆ˜</label>
                  <input type="number" id="box4_shareCount1" placeholder="100" step="1" onchange="calculateProfit('box4')" />
                </div>
                <div class="profit-input-group exchange-rate-inline">
                  <label>í™˜ìœ¨</label>
                  <input type="number" id="box4_exchangeRate1" placeholder="1470" step="1" value="1470" onchange="calculateProfit('box4')" />
                </div>
              </div>
              <div class="input-row">
                <input type="radio" id="box4_selectSet2" name="box4_priceSet" value="2" onchange="calculateProfit('box4')" style="width: auto; margin-bottom: 8px; flex-shrink: 0" />
                <div class="profit-input-group">
                  <input type="number" id="box4_buyPrice2" placeholder="300.00" step="0.01" onchange="calculateProfit('box4')" />
                </div>
                <div class="profit-input-group">
                  <input type="number" id="box4_shareCount2" placeholder="50" step="1" onchange="calculateProfit('box4')" />
                </div>
                <div class="profit-input-group exchange-rate-inline">
                  <input type="number" id="box4_exchangeRate2" placeholder="1470" step="1" value="1470" onchange="calculateProfit('box4')" />
                </div>
              </div>
            </div>

            <div class="profit-content">
              <div class="market-info">
                <div class="market-row" style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid #444">
                  <span class="market-label" style="font-size: 13px">í˜„ì¬ê°€:</span>
                  <span class="market-value" id="box4_currentPriceMarket" style="font-size: 20px">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="market-row"><span class="market-label">ì‹œì¥:</span><span class="market-value" id="box4_marketInfo">-</span></div>
                <div class="market-row"><span class="market-label">ë“±ë½:</span><span class="market-value" id="box4_changeInfo">-</span></div>
                <div class="market-row"><span class="market-label">ë“±ë½ë¥ :</span><span class="market-value" id="box4_pctInfo">-</span></div>
                <div class="market-row"><span class="market-label">ì‹œê°„:</span><span class="market-value" id="box4_timeInfo">-</span></div>
                <div class="market-row" style="margin-top: 8px"><span class="market-label">ìƒíƒœ:</span><span class="market-value" id="box4_statusInfo" style="font-size: 12px">-</span></div>
              </div>
              <div class="profit-calculation">
                <div class="profit-results">
                  <div class="profit-row"><span class="profit-label">ìˆ˜ìµë¥ :</span><span class="profit-value" id="box4_profitRate">-</span></div>
                  <div class="profit-row"><span class="profit-label">ìˆ˜ìµê¸ˆ($):</span><span class="profit-value" id="box4_profitAmount">-</span></div>
                  <div class="profit-row"><span class="profit-label">ìˆ˜ìµê¸ˆ(â‚©):</span><span class="profit-value" id="box4_profitAmountKRW">-</span></div>
                  <div class="profit-row"><span class="profit-label">í‰ê°€ê¸ˆ($):</span><span class="profit-value" id="box4_totalValue">-</span></div>
                  <div class="profit-row"><span class="profit-label">í‰ê°€ê¸ˆ(â‚©):</span><span class="profit-value" id="box4_totalValueKRW" style="color: #ffd700">-</span></div>
                </div>
                <div class="update-time" id="box4_updateTime">-</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ì°¨íŠ¸ ëª¨ë“œ (ìˆ¨ê¹€ ê¸°ë³¸) -->
        <div id="box4_chartMode" style="display: none; width: 100%; height: 100%; position: relative">
          <div class="input-group" style="position: relative; margin-bottom: 5px">
            <input type="text" id="input4" value="VANTAGE:TSLA" onkeypress="handleEnter(event, 4)" onclick="showHistoryDropdown('input4')" onblur="hideHistoryDropdown('input4')" autocomplete="off" />
            <div id="input4_history" class="input-history-dropdown"></div>
            <button onclick="updateChart(4)">Change</button>
            <button onclick="toggleMode('box4')" style="padding: 4px 8px; font-size: 14px; margin-left: 5px">ğŸ’°</button>
          </div>
          <div id="chart4" class="tradingview-widget-container" style="height: calc(100% - 40px)"></div>
        </div>
      </div>

      <div class="chart-box" id="box5">
        <div class="input-group" style="position: relative">
          <input type="text" id="input5" value="BINANCE:BTCUSDT" onkeypress="handleEnter(event, 5)" onclick="showHistoryDropdown('input5')" onblur="hideHistoryDropdown('input5')" autocomplete="off" />
          <div id="input5_history" class="input-history-dropdown"></div>
          <button onclick="updateChart(5)">Change</button>
        </div>
        <div id="chart5" class="tradingview-widget-container"></div>
      </div>

      <div class="chart-box" id="box6">
        <div class="input-group" style="position: relative">
          <input type="text" id="input6" value="NASDAQ:AAPL" onkeypress="handleEnter(event, 6)" onclick="showHistoryDropdown('input6')" onblur="hideHistoryDropdown('input6')" autocomplete="off" />
          <div id="input6_history" class="input-history-dropdown"></div>
          <button onclick="updateChart(6)">Change</button>
        </div>
        <div id="chart6" class="tradingview-widget-container"></div>
      </div>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
      // PRIVATE URL - ê°™ì€ ì„œë²„ ë‚´ ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©
      // const PRIVATE_TSLA_URL = "/tsla"; // Deprecated in favor of /stock?ticker=...

      function createWidget(containerId, symbol) {
        document.getElementById(containerId).innerHTML = "";
        new TradingView.widget({
          autosize: true,
          symbol: symbol,
          interval: "1",
          timezone: "Asia/Seoul",
          theme: "dark",
          style: "1",
          locale: "kr",
          toolbar_bg: "#f1f3f6",
          enable_publishing: false,
          hide_top_toolbar: false,
          allow_symbol_change: true,
          hide_legend: false,
          save_image: false,
          container_id: containerId,
        });
      }

      window.onload = function () {
        // localStorageì—ì„œ ì €ì¥ëœ ì°¨íŠ¸ ì‹¬ë³¼ ë¶ˆëŸ¬ì˜¤ê¸°
        loadChartSymbols();

        updateChart(1);
        updateChart(2);
        updateChart(3);
        updateChart(5);
        updateChart(6);

        // ìˆ˜ìµ ë°ì´í„° ë¡œë“œ (Box 1, Box 4)
        loadProfitData("box1");
        loadProfitData("box4");

        // ì´ˆê¸° í•œ ë²ˆì€ ì „ì²´ ë°ì´í„° ì¡°íšŒ
        fetchTeslaPrice(["box1", "box4"]);

        // ì´ˆê¸° ìƒíƒœ ì„¤ì • (ëª¨ë‘ OFF ìƒíƒœë¡œ ì‹œì‘)
        document.getElementById("box1_realtime").checked = false;
        document.getElementById("box4_realtime").checked = false;
        toggleRealtime("box1");
        toggleRealtime("box4");
      };

      // ì°¨íŠ¸ ì‹¬ë³¼ ì €ì¥
      function saveChartSymbol(chartNum, symbol) {
        localStorage.setItem("chart_symbol_" + chartNum, symbol);
        // íˆìŠ¤í† ë¦¬ì—ë„ ì €ì¥
        addToTickerHistory(symbol);
      }

      // í‹°ì»¤ íˆìŠ¤í† ë¦¬ ê´€ë¦¬
      function addToTickerHistory(symbol) {
        if (!symbol || symbol.trim() === "") return;

        let history = JSON.parse(localStorage.getItem("ticker_history") || "[]");

        // ì¤‘ë³µ ì œê±°
        history = history.filter((item) => item !== symbol);

        // ë§¨ ì•ì— ì¶”ê°€
        history.unshift(symbol);

        // ìµœì‹  20ê°œë§Œ ìœ ì§€
        history = history.slice(0, 20);

        localStorage.setItem("ticker_history", JSON.stringify(history));
      }

      function getTickerHistory() {
        return JSON.parse(localStorage.getItem("ticker_history") || "[]");
      }

      // íˆìŠ¤í† ë¦¬ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
      function showHistoryDropdown(inputId) {
        const input = document.getElementById(inputId);
        const dropdown = document.getElementById(inputId + "_history");
        const history = getTickerHistory();

        if (history.length === 0) {
          dropdown.innerHTML = '<div class="input-history-empty">íˆìŠ¤í† ë¦¬ ì—†ìŒ</div>';
        } else {
          dropdown.innerHTML = history.map((item) => `<div class="input-history-item" onclick="selectHistoryItem('${inputId}', '${item}')">${item}</div>`).join("");
        }

        dropdown.style.display = "block";
      }

      // íˆìŠ¤í† ë¦¬ í•­ëª© ì„ íƒ
      function selectHistoryItem(inputId, value) {
        document.getElementById(inputId).value = value;
        document.getElementById(inputId + "_history").style.display = "none";

        // ì°¨íŠ¸ ë²ˆí˜¸ ì¶”ì¶œ (input1, input2, ...)
        const chartNum = inputId.replace("input", "");
        updateChart(parseInt(chartNum));
      }

      // íˆìŠ¤í† ë¦¬ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¸°ê¸°
      function hideHistoryDropdown(inputId) {
        setTimeout(() => {
          document.getElementById(inputId + "_history").style.display = "none";
        }, 200); // í´ë¦­ ì´ë²¤íŠ¸ê°€ ì²˜ë¦¬ë  ì‹œê°„ì„ ì¤Œ
      }

      // ëª¨ë“  ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
      function hideAllDropdowns() {
        document.querySelectorAll(".input-history-dropdown").forEach((dropdown) => {
          dropdown.style.display = "none";
        });
      }

      // ESC í‚¤ë¡œ ëª¨ë“  ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          hideAllDropdowns();
        }
      });

      // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
      document.addEventListener("click", function (e) {
        if (!e.target.closest(".input-group")) {
          hideAllDropdowns();
        }
      });

      // ì°¨íŠ¸ ì‹¬ë³¼ ë¶ˆëŸ¬ì˜¤ê¸°
      function loadChartSymbols() {
        const symbols = {
          1: localStorage.getItem("chart_symbol_1") || "VANTAGE:TSLA",
          2: localStorage.getItem("chart_symbol_2") || "VANTAGE:QQQ",
          3: localStorage.getItem("chart_symbol_3") || "FX_IDC:USDKRW",
          5: localStorage.getItem("chart_symbol_5") || "BINANCE:BTCUSDT",
          6: localStorage.getItem("chart_symbol_6") || "NASDAQ:AAPL",
        };

        document.getElementById("input1").value = symbols[1];
        document.getElementById("input2").value = symbols[2];
        document.getElementById("input3").value = symbols[3];
        document.getElementById("input5").value = symbols[5];
        document.getElementById("input6").value = symbols[6];
      }

      function updateChart(id) {
        const symbol = document.getElementById("input" + id).value;
        saveChartSymbol(id, symbol); // ì‹¬ë³¼ ë³€ê²½ ì‹œ ìë™ ì €ì¥
        createWidget("chart" + id, symbol);
      }

      function handleEnter(e, id) {
        if (e.key === "Enter") {
          updateChart(id);
        }
      }

      async function fetchTeslaPrice(targetBoxes = ["box1", "box4"]) {
        // ë‹¨ì¼ ë¬¸ìì—´ë¡œ ë„˜ì–´ì˜¨ ê²½ìš° ë°°ì—´ë¡œ ë³€í™˜
        if (typeof targetBoxes === "string") {
          targetBoxes = [targetBoxes];
        }

        // ê° ë°•ìŠ¤ë³„ë¡œ ë¹„ë™ê¸° ìš”ì²­ ì²˜ë¦¬
        const promises = targetBoxes.map(async (boxId) => {
          // ìƒíƒœ ì—…ë°ì´íŠ¸
          const statusEl = document.getElementById(boxId + "_statusInfo");
          if (statusEl) {
            statusEl.textContent = "ì—…ë°ì´íŠ¸ ì¤‘...";
            statusEl.style.color = "#ffd700";
          }

          // í‹°ì»¤ ê²°ì •
          let ticker = "TSLA";
          if (boxId === "box1") {
            const input = document.getElementById("box1_ticker");
            if (input) ticker = input.value.trim().toUpperCase() || "TSLA";
          }
          // box4ëŠ” "TSLA" ê³ ì •

          try {
            const response = await fetch(`/stock?ticker=${ticker}`, {
              method: "GET",
              headers: {
                Accept: "application/json",
              },
            });

            if (!response.ok) {
              throw new Error("Network response was not ok");
            }

            const data = await response.json();
            window.lastResponse = data; // ë””ë²„ê¹…ìš© (ë§ˆì§€ë§‰ ì‘ë‹µë§Œ ì €ì¥ë¨)
            if (!window.boxResponses) window.boxResponses = {};
            window.boxResponses[boxId] = data;

            let currentPrice;

            // ì„œë²„ ì‘ë‹µ í˜•ì‹ ì²˜ë¦¬
            if (data.price) {
              currentPrice = parseFloat(data.price);
            } else if (typeof data === "number") {
              currentPrice = data;
            } else if (data.currentPrice) {
              currentPrice = parseFloat(data.currentPrice);
            } else if (data.lastPrice) {
              currentPrice = parseFloat(data.lastPrice);
            } else {
              const values = Object.values(data).filter((v) => typeof v === "number");
              currentPrice = values[0];
            }

            if (currentPrice && !isNaN(currentPrice)) {
              const updateTimeStr = "ì—…ë°ì´íŠ¸: " + new Date().toLocaleTimeString("ko-KR");
              const currentPriceEl = document.getElementById(boxId + "_currentPriceMarket");

              if (currentPriceEl) {
                currentPriceEl.textContent = "$" + currentPrice.toFixed(2);

                // ë“±ë½ì— ë”°ë¥¸ ìƒ‰ìƒ ì ìš©
                const isPositive = !(data.mod || "").includes("-");
                currentPriceEl.className = "market-value " + (isPositive ? "price-positive" : "price-negative");

                document.getElementById(boxId + "_updateTime").textContent = updateTimeStr;

                // ì‹œì¥ ì •ë³´ í‘œì‹œ
                if (document.getElementById(boxId + "_marketInfo")) document.getElementById(boxId + "_marketInfo").textContent = data.market || "-";

                const changeEl = document.getElementById(boxId + "_changeInfo");
                if (changeEl) {
                  changeEl.textContent = data.mod || "-";
                  changeEl.className = "market-value " + ((data.mod || "").includes("-") ? "profit-negative" : "profit-positive");
                }

                const pctEl = document.getElementById(boxId + "_pctInfo");
                if (pctEl) {
                  pctEl.textContent = data.pct || "-";
                  pctEl.className = "market-value " + ((data.pct || "").includes("-") ? "profit-negative" : "profit-positive");
                }

                if (document.getElementById(boxId + "_timeInfo")) document.getElementById(boxId + "_timeInfo").textContent = data.time || "-";

                // ìƒíƒœ ì—…ë°ì´íŠ¸ - ì„±ê³µ
                if (statusEl) {
                  statusEl.innerHTML = '<span style="color: #00e676; cursor: pointer; text-decoration: underline;" onclick="showLastResponse(\'' + boxId + '\')" title="í´ë¦­í•˜ë©´ ì‘ë‹µ ì „ë¬¸ ë³´ê¸°">ì¡°íšŒ ì„±ê³µ</span>';
                  // statusEl.style.color = "#00e676";
                }

                // ìˆ˜ìµ ê³„ì‚° ì‹¤í–‰
                setTimeout(() => calculateProfit(boxId, currentPrice), 100);
              }
            } else {
              throw new Error("Price data not found or invalid: " + JSON.stringify(data));
            }
          } catch (error) {
            console.error(`${boxId} ì‹¤ì‹œê°„ ì£¼ê°€ ì¡°íšŒ ì‹¤íŒ¨:`, error);

            let errorDetail = "";
            if (error.message.includes("NetworkError") || error.message.includes("Failed to fetch")) {
              errorDetail = "ì„œë²„ ì—°ê²° ì‹¤íŒ¨";
            } else if (error.message.includes("404")) {
              errorDetail = "404 Not Found";
            } else if (error.message.includes("CORS")) {
              errorDetail = "CORS ì°¨ë‹¨";
            } else {
              errorDetail = error.message;
            }

            const statusEl = document.getElementById(boxId + "_statusInfo");
            if (statusEl) {
              statusEl.innerHTML = '<span style="color: #ef5350; cursor: pointer; text-decoration: underline;" onclick="showLastResponse(\'' + boxId + '\')" title="í´ë¦­í•˜ë©´ ì‘ë‹µ ì „ë¬¸ ë³´ê¸°">ì¡°íšŒ ì‹¤íŒ¨</span>';
              document.getElementById(boxId + "_updateTime").innerHTML = '<span style="color: #ef5350;">' + errorDetail + "</span>";
            }
          } finally {
            // ë¦¬ì…‹ ë¡œì§ í•„ìš” ì‹œ ì—¬ê¸°ì— ì¶”ê°€
            const checkbox = document.getElementById(boxId + "_realtime");
            if (checkbox && checkbox.checked) {
              if (window.timerState && window.timerState[boxId]) {
                window.timerState[boxId].remaining = 300;
              }
            }
          }
        });

        await Promise.all(promises);
      }

      function calculateProfit(boxId, currentPrice) {
        // í˜„ì¬ ê°€ê²©ì´ ì—†ìœ¼ë©´ í™”ë©´ì—ì„œ ê°€ì ¸ì˜¤ê¸°
        if (!currentPrice || isNaN(currentPrice)) {
          const currentPriceText = document.getElementById(boxId + "_currentPriceMarket").textContent;
          if (currentPriceText && currentPriceText.startsWith("$")) {
            currentPrice = parseFloat(currentPriceText.replace("$", ""));
          }
        }

        // ì„ íƒëœ ì„¸íŠ¸ í™•ì¸
        const selectedSet = document.querySelector('input[name="' + boxId + '_priceSet"]:checked')?.value || "1";

        // ì„ íƒëœ ì„¸íŠ¸ì˜ ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
        const buyPriceInput = document.getElementById(boxId + "_buyPrice" + selectedSet);
        const shareCountInput = document.getElementById(boxId + "_shareCount" + selectedSet);
        const exchangeRateInlineInput = document.getElementById(boxId + "_exchangeRate" + selectedSet);

        if (!buyPriceInput || !shareCountInput) {
          console.error("Selected input elements not found for set " + selectedSet + " in " + boxId);
          return;
        }

        // ì…ë ¥ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ë¦¬í„´
        const buyPriceValue = buyPriceInput.value.trim();
        const shareCountValue = shareCountInput.value.trim();
        const exchangeRateValue = exchangeRateInlineInput?.value.trim() || "1470";

        if (!buyPriceValue || !shareCountValue) {
          document.getElementById(boxId + "_profitRate").textContent = "ì…ë ¥ í•„ìš”";
          document.getElementById(boxId + "_profitAmount").textContent = "-";
          document.getElementById(boxId + "_profitAmountKRW").textContent = "-";
          document.getElementById(boxId + "_totalValue").textContent = "-";
          document.getElementById(boxId + "_totalValueKRW").textContent = "-";
          return;
        }

        const buyPrice = parseFloat(buyPriceValue);
        const shareCount = parseInt(shareCountValue);
        const exchangeRate = parseInt(exchangeRateValue);

        if (isNaN(buyPrice) || isNaN(shareCount) || !currentPrice || isNaN(currentPrice) || isNaN(exchangeRate)) {
          document.getElementById(boxId + "_profitRate").textContent = "í˜„ì¬ê°€ ë¡œë”©ì¤‘";
          return;
        }

        const profitPerShare = currentPrice - buyPrice;
        const totalProfit = profitPerShare * shareCount;
        const profitRate = (profitPerShare / buyPrice) * 100;
        const totalValue = currentPrice * shareCount;

        const profitRateElement = document.getElementById(boxId + "_profitRate");
        profitRateElement.textContent = (profitRate >= 0 ? "+" : "") + profitRate.toFixed(2) + "%";
        profitRateElement.className = "profit-value " + (profitRate >= 0 ? "profit-positive" : "profit-negative");

        const profitAmountElement = document.getElementById(boxId + "_profitAmount");
        const absProfit = Math.abs(totalProfit);
        const sign = totalProfit >= 0 ? "+" : "-";
        profitAmountElement.textContent = sign + "$" + absProfit.toLocaleString("en-US", { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        profitAmountElement.className = "profit-value " + (totalProfit >= 0 ? "profit-positive" : "profit-negative");

        // ìˆ˜ìµê¸ˆì•¡ ì›í™” ê³„ì‚°
        const totalProfitKRW = totalProfit * exchangeRate;
        const profitAmountKRWElement = document.getElementById(boxId + "_profitAmountKRW");
        profitAmountKRWElement.textContent = (totalProfitKRW >= 0 ? "+" : "") + totalProfitKRW.toLocaleString("ko-KR", { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        profitAmountKRWElement.className = "profit-value " + (totalProfitKRW >= 0 ? "profit-positive" : "profit-negative");

        // ì–‘ë„ì„¸ ê³„ì‚° í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        if (totalProfitKRW > 0) {
          profitAmountKRWElement.style.cursor = "pointer";
          profitAmountKRWElement.title = "í´ë¦­í•˜ì—¬ ì–‘ë„ì„¸(22%) í™•ì¸";
          profitAmountKRWElement.onclick = function () {
            const taxAmount = Math.floor(totalProfitKRW * 0.22);
            alert("ì–‘ë„ì†Œë“ì„¸ (22%): " + taxAmount.toLocaleString("ko-KR") + "ì›\n" + "ì„¸í›„ ìˆ˜ìµ: " + (totalProfitKRW - taxAmount).toLocaleString("ko-KR") + "ì›");
          };
        } else {
          profitAmountKRWElement.style.cursor = "default";
          profitAmountKRWElement.title = "";
          profitAmountKRWElement.onclick = null;
        }

        document.getElementById(boxId + "_totalValue").textContent = "$" + totalValue.toLocaleString("en-US", { minimumFractionDigits: 0, maximumFractionDigits: 0 });

        // í‰ê°€ê¸ˆì•¡ ì›í™” ê³„ì‚°
        const totalValueKRW = totalValue * exchangeRate;
        document.getElementById(boxId + "_totalValueKRW").textContent = totalValueKRW.toLocaleString("ko-KR", { minimumFractionDigits: 0, maximumFractionDigits: 0 });
      }

      function saveProfitData(boxId) {
        if (boxId === "box1") {
          const ticker = document.getElementById("box1_ticker").value;
          localStorage.setItem("tsla_box1_ticker", ticker);
        }
        const buyPrice1 = document.getElementById(boxId + "_buyPrice1").value;
        const shareCount1 = document.getElementById(boxId + "_shareCount1").value;
        const exchangeRate1 = document.getElementById(boxId + "_exchangeRate1").value;
        const buyPrice2 = document.getElementById(boxId + "_buyPrice2").value;
        const shareCount2 = document.getElementById(boxId + "_shareCount2").value;
        const exchangeRate2 = document.getElementById(boxId + "_exchangeRate2").value;
        const selectedSet = document.querySelector('input[name="' + boxId + '_priceSet"]:checked')?.value || "1";

        const prefix = "tsla_" + boxId + "_"; // í‚¤ ê°’ì— boxId í¬í•¨

        localStorage.setItem(prefix + "buyPrice1", buyPrice1);
        localStorage.setItem(prefix + "shareCount1", shareCount1);
        localStorage.setItem(prefix + "exchangeRate1", exchangeRate1);
        localStorage.setItem(prefix + "buyPrice2", buyPrice2);
        localStorage.setItem(prefix + "shareCount2", shareCount2);
        localStorage.setItem(prefix + "exchangeRate2", exchangeRate2);
        localStorage.setItem(prefix + "selectedSet", selectedSet);

        // ì´ì „ í˜¸í™˜ì„±ì„ ìœ„í•´ box4ëŠ” ê¸°ì¡´ í‚¤ë„ ìœ ì§€í• ì§€ ê³ ë¯¼í–ˆì§€ë§Œ, box4ë„ ë§ˆì´ê·¸ë ˆì´ì…˜ í•˜ëŠ”ê²Œ ê¹”ë”í•¨.
        // í•˜ì§€ë§Œ ì‚¬ìš©ìê°€ ê¸°ì¡´ ë°ì´í„°ë¥¼ ìƒì§€ ì•Šìœ¼ë ¤ë©´?
        // -> loadProfitDataì—ì„œ ê¸°ì¡´ í‚¤ë„ ì²´í¬í•˜ë©´ ë¨.

        alert(boxId + " ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (ì„¸íŠ¸ 1, 2 ë° í™˜ìœ¨ ëª¨ë‘ ì €ì¥)");

        // í˜„ì¬ í‘œì‹œëœ ê°€ê²©ìœ¼ë¡œ ì¦‰ì‹œ ê³„ì‚°
        const currentPriceText = document.getElementById(boxId + "_currentPriceMarket").textContent;
        if (currentPriceText && currentPriceText.startsWith("$")) {
          const currentPrice = parseFloat(currentPriceText.replace("$", ""));
          calculateProfit(boxId, currentPrice);
        } else {
          fetchTeslaPrice(); // ê°€ê²©ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ì¡°íšŒ
        }
      }

      function toggleMode(boxId) {
        const profitMode = document.getElementById(boxId + "_profitMode");
        const chartMode = document.getElementById(boxId + "_chartMode");

        if (chartMode.style.display === "none") {
          // ìˆ˜ìµê³„ì‚° ëª¨ë“œ -> ì°¨íŠ¸ ëª¨ë“œ
          chartMode.style.display = "block";
          profitMode.style.display = "none";

          // ì°¨íŠ¸ ì´ˆê¸°í™” (ì²˜ìŒ í•œ ë²ˆë§Œ) - idì—ì„œ ìˆ«ì ì¶”ì¶œ
          const chartNum = boxId.replace("box", "");
          if (!document.getElementById("chart" + chartNum).hasChildNodes()) {
            updateChart(chartNum);
          }
        } else {
          // ì°¨íŠ¸ ëª¨ë“œ -> ìˆ˜ìµê³„ì‚° ëª¨ë“œ
          chartMode.style.display = "none";
          profitMode.style.display = "flex";
        }
      }

      function loadProfitData(boxId) {
        if (boxId === "box1") {
          const savedTicker = localStorage.getItem("tsla_box1_ticker");
          if (savedTicker) {
            document.getElementById("box1_ticker").value = savedTicker;
          }
        }
        // ê¸°ì¡´ box4 ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì§€ì›
        // box4ì˜ ê²½ìš° ì´ì „ í‚¤(tsla_buyPrice1 ë“±)ë¥¼ ë¨¼ì € ì°¾ê³  ì—†ìœ¼ë©´ ìƒˆ í‚¤ ì‚¬ìš©

        let prefix = "tsla_" + boxId + "_";
        let legacyPrefix = "tsla_";
        let useLegacy = boxId === "box4" && !localStorage.getItem(prefix + "buyPrice1") && localStorage.getItem(legacyPrefix + "buyPrice1");

        const finalPrefix = useLegacy ? legacyPrefix : prefix;

        const savedBuyPrice1 = localStorage.getItem(finalPrefix + "buyPrice1");
        const savedShareCount1 = localStorage.getItem(finalPrefix + "shareCount1");
        const savedExchangeRate1 = localStorage.getItem(finalPrefix + "exchangeRate1");
        const savedBuyPrice2 = localStorage.getItem(finalPrefix + "buyPrice2");
        const savedShareCount2 = localStorage.getItem(finalPrefix + "shareCount2");
        const savedExchangeRate2 = localStorage.getItem(finalPrefix + "exchangeRate2");
        const savedSelectedSet = localStorage.getItem(finalPrefix + "selectedSet");

        if (savedBuyPrice1) document.getElementById(boxId + "_buyPrice1").value = savedBuyPrice1;
        if (savedShareCount1) document.getElementById(boxId + "_shareCount1").value = savedShareCount1;
        if (savedExchangeRate1) document.getElementById(boxId + "_exchangeRate1").value = savedExchangeRate1;
        if (savedBuyPrice2) document.getElementById(boxId + "_buyPrice2").value = savedBuyPrice2;
        if (savedShareCount2) document.getElementById(boxId + "_shareCount2").value = savedShareCount2;
        if (savedExchangeRate2) document.getElementById(boxId + "_exchangeRate2").value = savedExchangeRate2;
        if (savedSelectedSet) {
          document.getElementById(boxId + "_selectSet" + savedSelectedSet).checked = true;
        } else {
          document.getElementById(boxId + "_selectSet1").checked = true;
        }
      }

      // ë§ˆì§€ë§‰ ì‘ë‹µ ì „ë¬¸ ë³´ê¸°
      function showLastResponse(boxId) {
        let data = window.lastResponse;
        if (boxId && window.boxResponses && window.boxResponses[boxId]) {
          data = window.boxResponses[boxId];
        }

        if (data) {
          const jsonStr = JSON.stringify(data, null, 2);
          alert((boxId ? boxId + " " : "") + "ë§ˆì§€ë§‰ ì„œë²„ ì‘ë‹µ:\n\n" + jsonStr);
          console.log("Last Response:", data);
        } else {
          alert("ì €ì¥ëœ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.");
        }
      }

      // ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸ ìƒíƒœ ê´€ë¦¬
      window.timerState = {
        box1: {
          interval: null,
          remaining: 300,
          timerId: "box1_timer",
          checkboxId: "box1_realtime",
        },
        box4: {
          interval: null,
          remaining: 300,
          timerId: "box4_timer",
          checkboxId: "box4_realtime",
        },
      };

      // ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸ ì‹œì‘
      function startCountdown(boxId) {
        stopCountdown(boxId);

        const state = window.timerState[boxId];
        if (!state) return;

        state.remaining = 300;
        updateTimerDisplay(boxId);

        state.interval = setInterval(() => {
          state.remaining--;
          if (state.remaining <= 0) {
            state.remaining = 300; // ë‹¤ì‹œ 5ë¶„ìœ¼ë¡œ ë¦¬ì…‹
            fetchTeslaPrice(boxId); // í•´ë‹¹ ë°•ìŠ¤ë§Œ ì—…ë°ì´íŠ¸ ìš”ì²­
          }
          updateTimerDisplay(boxId);
        }, 1000);
      }

      // ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸ ì¤‘ì§€
      function stopCountdown(boxId) {
        const state = window.timerState[boxId];
        if (state && state.interval) {
          clearInterval(state.interval);
          state.interval = null;
        }
      }

      // íƒ€ì´ë¨¸ í™”ë©´ ì—…ë°ì´íŠ¸
      function updateTimerDisplay(boxId) {
        const state = window.timerState[boxId];
        if (!state) return;

        const minutes = Math.floor(state.remaining / 60);
        const seconds = state.remaining % 60;
        const display = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

        const timerEl = document.getElementById(state.timerId);
        if (timerEl) {
          timerEl.textContent = display;
        }
      }

      // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í† ê¸€
      function toggleRealtime(boxId) {
        const checkbox = document.getElementById(boxId + "_realtime");
        const timerEl = document.getElementById(window.timerState[boxId].timerId);

        if (!checkbox || !timerEl) return;

        const isRealtime = checkbox.checked;

        if (isRealtime) {
          // ì‹¤ì‹œê°„ ON
          startCountdown(boxId);
          timerEl.classList.remove("paused");

          const updateTimeEl = document.getElementById(boxId + "_updateTime");
          if (updateTimeEl) updateTimeEl.textContent = "ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ON";

          // ì¼œìë§ˆì í•œë²ˆ ì¡°íšŒ
          fetchTeslaPrice(boxId);
        } else {
          // ì‹¤ì‹œê°„ OFF
          stopCountdown(boxId);
          timerEl.classList.add("paused");

          const updateTimeEl = document.getElementById(boxId + "_updateTime");
          if (updateTimeEl) updateTimeEl.textContent = "ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ OFF (ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ í•„ìš”)";
        }
      }
    </script>
  </body>
</html>
